<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelf Life | Southold Free Library</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.05), rgba(52, 152, 219, 0.05));
            border: 1px solid rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-family: 'Merriweather', serif;
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            display: inline-block;
            position: relative;
            flex-shrink: 0;
            margin-right: 5px;
        }
        
        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8bc34a 0%, #8bc34a 45%, #3498db 55%, #3498db 100%);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 34px;
            height: 28px;
            background: white;
            border-radius: 2px;
            clip-path: polygon(
                0% 100%, 
                0% 15%, 
                3% 12%, 
                8% 15%, 
                15% 10%, 
                22% 15%, 
                28% 8%, 
                35% 12%, 
                42% 5%, 
                50% 0%, 
                58% 5%, 
                65% 12%, 
                72% 8%, 
                78% 15%, 
                85% 10%, 
                92% 15%, 
                97% 12%, 
                100% 15%, 
                100% 100%
            );
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .date-info {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.1), rgba(52, 152, 219, 0.1));
            border: 1px solid rgba(52, 152, 219, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .game-number {
            font-weight: 600;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.1rem;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-container {
            background: white;
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: inline-block;
        }
        
        .streak-display {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .clue {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.08), rgba(52, 152, 219, 0.08));
            border: 1px solid rgba(52, 152, 219, 0.2);
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
            border-radius: 5px;
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .guess {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
            font-weight: 500;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .correct {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.15), rgba(139, 195, 74, 0.1));
            border: 2px solid #8bc34a;
            color: #2e7d32;
        }
        
        .incorrect {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }
        
        .skipped {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            color: #6b7280;
            font-style: italic;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        button:hover {
            background: linear-gradient(135deg, #7cb342, #2980b9);
            transform: translateY(-1px);
        }
        
        .skip-btn {
            background: #6b7280;
        }
        
        .skip-btn:hover {
            background: #4b5563;
        }
        
        .submit-btn {
            min-width: 50px;
            font-size: 20px;
            padding: 12px;
        }
        
        .result {
            text-align: center;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .win {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #16a34a;
        }
        
        .lose {
            background: #fef2f2;
            color: #991b1b;
            border: 2px solid #dc2626;
        }
        
        .share-button {
            background: #10b981;
            margin: 10px;
        }
        
        .share-button:hover {
            background: #059669;
        }
        
        .library-link {
            background: white;
            border: 2px solid #2563eb;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .library-link a {
            background: linear-gradient(135deg, #8bc34a, #3498db);
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .library-link a:hover {
            background: linear-gradient(135deg, #7cb342, #2980b9);
            transform: translateY(-1px);
        }
        
        .achievement {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
            color: #92400e;
            font-weight: 600;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .nav-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .nav-buttons button {
            margin: 0 10px 10px 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Archive styles */
        .archive-day {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .archive-day:hover {
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .archive-day.completed {
            border-color: #16a34a;
            background: #f0fdf4;
        }
        
        .archive-day.current {
            border-color: #2563eb;
            background: #eff6ff;
            font-weight: 600;
        }
        
        .archive-info h4 {
            margin: 0 0 5px 0;
            color: #1f2937;
        }
        
        .archive-book {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0;
        }
        
        .archive-status {
            font-size: 1.5rem;
        }
        
        /* Responsive design */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .input-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .input-group input {
                width: 100%;
            }
            
            .nav-buttons button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Shelf Life</h1>
        <p class="subtitle">Daily Book Guessing Game</p>
        <div class="date-info">
            <div class="game-number" id="game-number">Loading...</div>
            <div id="current-date"></div>
        </div>
    </div>

    <div style="text-align: center;">
        <div class="stats-container">
            <div class="streak-display">
                ğŸ”¥ <span id="streak-count">0</span> day streak
            </div>
        </div>
    </div>

    <div class="nav-buttons">
        <button onclick="showTodaysGame()">ğŸ“… Today's Game</button>
        <button onclick="showArchiveList()">ğŸ—‚ï¸ Archive</button>
    </div>

    <div id="game-section">
        <div class="container">
            <h3>ğŸ“‹ Clues (<span id="clue-count">1</span>/6)</h3>
            <div id="clues"></div>
        </div>

        <div class="container" id="input-section">
            <h3>Your Guess</h3>
            <div class="input-group">
                <input type="text" id="guess-input" placeholder="Enter book title...">
                <button class="submit-btn" onclick="makeGuess()">â†’</button>
                <button class="skip-btn" onclick="skipClue()">Skip</button>
            </div>
        </div>

        <div class="container hidden" id="guesses-section">
            <h3>Your Guesses (<span id="guess-count">0</span>/6)</h3>
            <div id="guesses"></div>
        </div>

        <div class="container hidden" id="result-section">
            <div id="result-text"></div>
            <div style="text-align: center;">
                <button class="share-button" onclick="shareResults()">ğŸ“‹ Copy Results</button>
            </div>
            <div class="library-link">
                <p><strong>ğŸ“– Find this book at Southold Free Library</strong></p>
                <a href="#" id="catalog-link" target="_blank">Search Our Catalog</a>
            </div>
            <div id="achievement-display"></div>
        </div>
    </div>

    <div class="container hidden" id="archive-section">
        <h3>ğŸ—‚ï¸ Game Archive</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">Click any day to play that puzzle</p>
        <div id="archive-list"></div>
    </div>

    <div style="text-align: center; margin-top: 40px; padding: 25px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
        <p style="margin: 0 0 10px 0; font-weight: 500;">Powered by <a href="https://southoldlibrary.org" target="_blank" style="color: #3498db; text-decoration: none; font-weight: 600;">Southold Free Library</a></p>
        <p style="margin: 0; font-size: 12px;">Â© 2025 Southold Free Library. All rights reserved.</p>
    </div>

    <!-- Audio elements for sound effects -->
    <audio id="correct-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmI=" type="audio/wav">
    </audio>
    <audio id="incorrect-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRhoCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YfYBAAC4u7i4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4" type="audio/wav">
    </audio>
    <audio id="win-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRhwCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YfgBAADf4Nyc3ODUoNvg2aDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZoNvg2qDb4Nqg2+DZ" type="audio/wav">
    </audio>

    <script>
        // Game state
        let currentBook;
        let guesses = [];
        let cluesShown = 1;
        let gameOver = false;
        let selectedDate = null;
        let gameHistory = {};
        let playerStats = { streak: 0, gamesPlayed: 0, gamesWon: 0, achievements: [] };
        let books = [];

        // Google Sheets configuration
        const SHEET_ID = 'YOUR_SHEET_ID_HERE'; // Replace with your Google Sheet ID
        const SHEET_NAME = 'Books'; // Name of your sheet tab
        const API_KEY = 'YOUR_API_KEY_HERE'; // Replace with your Google Sheets API key

        // Default books (fallback if Google Sheets fails)
        const defaultBooks = [
            { title: "PRIDE AND PREJUDICE", author: "Jane Austen", isbn: "9780141439518" },
            { title: "THE GREAT GATSBY", author: "F. Scott Fitzgerald", isbn: "9780743273565" },
            { title: "TO KILL A MOCKINGBIRD", author: "Harper Lee", isbn: "9780061120084" },
            { title: "HARRY POTTER AND THE SORCERER'S STONE", author: "J.K. Rowling", isbn: "9780439708180" },
            { title: "NINETEEN EIGHTY-FOUR", author: "George Orwell", isbn: "9780451524935" }
        ];

        // Initialize with default books
        books = [...defaultBooks];

        // Sound effects
        function playSound(type) {
            try {
                const sound = document.getElementById(`${type}-sound`);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(() => {
                        // Audio play failed, ignore silently
                    });
                }
            } catch (e) {
                // Ignore audio errors
            }
        }

        // Google Sheets Integration
        async function loadBooksFromSheet() {
            if (!SHEET_ID || !API_KEY || SHEET_ID === 'YOUR_SHEET_ID_HERE') {
                console.log('Using default books - Google Sheets not configured');
                return defaultBooks;
            }

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`
                );
                
                if (!response.ok) throw new Error('Failed to fetch from Google Sheets');
                
                const data = await response.json();
                const rows = data.values;
                
                if (!rows || rows.length <= 1) throw new Error('No data found');
                
                const booksFromSheet = rows.slice(1).map(row => ({
                    title: (row[0] || '').toUpperCase().trim(),
                    author: (row[1] || '').trim(),
                    isbn: (row[2] || '').trim(),
                    clue1: (row[3] || '').trim(),
                    clue2: (row[4] || '').trim(),
                    clue3: (row[5] || '').trim(),
                    clue4: (row[6] || '').trim(),
                    clue5: (row[7] || '').trim(),
                    clue6: (row[8] || '').trim()
                })).filter(book => book.title && book.author);
                
                console.log(`Loaded ${booksFromSheet.length} books from Google Sheets`);
                return booksFromSheet.length > 0 ? booksFromSheet : defaultBooks;
                
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                return defaultBooks;
            }
        }

        async function refreshFromSheet() {
            // Function removed - refresh button no longer available
        }

        // Initialize books on page load
        loadBooksFromSheet().then(loadedBooks => {
            books = loadedBooks;
            initGame();
        });

        // Utility functions
        function normalizeForComparison(title) {
            return title
                .toUpperCase()
                .trim()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/^(THE|A|AN)\s+/g, '')
                .replace(/\bNINETEEN EIGHTY FOUR\b/g, '1984')
                .replace(/\bNINETEEN EIGHTY THREE\b/g, '1983')
                .replace(/\bTWO THOUSAND\b/g, '2000')
                .replace(/\bONE\b/g, '1').replace(/\bTWO\b/g, '2').replace(/\bTHREE\b/g, '3')
                .replace(/\bFOUR\b/g, '4').replace(/\bFIVE\b/g, '5').replace(/\bSIX\b/g, '6')
                .replace(/\bSEVEN\b/g, '7').replace(/\bEIGHT\b/g, '8').replace(/\bNINE\b/g, '9')
                .replace(/\bTEN\b/g, '10').replace(/\bTWENTY\b/g, '20').replace(/\bTHIRTY\b/g, '30')
                .trim();
        }

        function titlesMatch(guess, target) {
            return normalizeForComparison(guess) === normalizeForComparison(target);
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // Enhanced daily book selection with time-based rotation
        function getTodaysBook(date = null) {
            const targetDate = date || selectedDate || new Date();
            const startDate = new Date('2025-01-01'); // Match the game numbering start date
            const daysSinceStart = Math.floor((targetDate - startDate) / (24 * 60 * 60 * 1000));
            const bookIndex = Math.max(0, daysSinceStart) % books.length;
            return books[bookIndex];
        }

        function getDayNumber(date = null) {
            const targetDate = date || selectedDate || new Date();
            const startDate = new Date('2025-01-01'); // Start from Jan 1, 2025
            const daysSinceStart = Math.floor((targetDate - startDate) / (24 * 60 * 60 * 1000));
            return Math.max(1, daysSinceStart + 1); // Ensure it starts at 001
        }

        function showCurrentDate() {
            const targetDate = selectedDate || new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = targetDate.toLocaleDateString('en-US', options);
            document.getElementById('game-number').textContent = `Game #${getDayNumber(targetDate).toString().padStart(3, '0')}`;
        }

        function generateClues(book) {
            // Use custom clues from Google Sheets if available
            if (book.clue1) {
                return [
                    book.clue1 || 'ğŸŒŸ A compelling story that has captivated readers',
                    book.clue2 || `ğŸ‘¤ Author: ${book.author.split(' ').slice(-1)[0]}`,
                    book.clue3 || 'ğŸ“… Era: Classic literature',
                    book.clue4 || 'ğŸ­ Themes: Human nature and society',
                    book.clue5 || 'ğŸ“– Setting: Various meaningful locations',
                    book.clue6 || 'ğŸ‘¥ Features: Memorable characters'
                ].filter(clue => clue.trim());
            }

            // Default clue templates
            const specificClues = {
                "PRIDE AND PREJUDICE": [
                    "ğŸŒŸ A spirited woman and proud gentleman overcome first judgments to find love",
                    "ğŸ‘¤ Author: British author, Austen",
                    "ğŸ“… Published: 1813",
                    "ğŸ­ Themes: Social class, marriage, personal growth through understanding",
                    "ğŸ“– Setting: English countryside estates in the Regency era", 
                    "ğŸ‘¥ Character: Elizabeth Bennet"
                ],
                "THE GREAT GATSBY": [
                    "ğŸŒŸ A mysterious millionaire throws lavish parties hoping to win back his lost love",
                    "ğŸ‘¤ Author: American author, Fitzgerald",
                    "ğŸ“… Published: 1925",
                    "ğŸ­ Themes: The American Dream, wealth vs morality, impossible past",
                    "ğŸ“– Setting: Long Island and New York City, summer of 1922",
                    "ğŸ‘¥ Character: Jay Gatsby"
                ],
                "TO KILL A MOCKINGBIRD": [
                    "ğŸŒŸ A child witnesses her father defend an innocent man in a charged trial",
                    "ğŸ‘¤ Author: American author, Lee", 
                    "ğŸ“… Published: 1960",
                    "ğŸ­ Themes: Racial injustice, moral courage, loss of innocence",
                    "ğŸ“– Setting: Small town Alabama during the 1930s",
                    "ğŸ‘¥ Character: Scout Finch"
                ],
                "HARRY POTTER AND THE SORCERER'S STONE": [
                    "ğŸŒŸ An orphaned boy discovers he's famous in a magical world",
                    "ğŸ‘¤ Author: British author, Rowling",
                    "ğŸ“… Published: 1997", 
                    "ğŸ­ Themes: Good vs evil, friendship, sacrifice, coming of age",
                    "ğŸ“– Setting: A school of witchcraft and wizardry in Scotland",
                    "ğŸ‘¥ Character: Harry Potter"
                ],
                "NINETEEN EIGHTY-FOUR": [
                    "ğŸŒŸ In a surveillance state where Big Brother watches all, one man dares remember freedom",
                    "ğŸ‘¤ Author: British author, Orwell",
                    "ğŸ“… Published: 1949",
                    "ğŸ­ Themes: Totalitarianism, surveillance, truth manipulation, individual freedom",
                    "ğŸ“– Setting: Dystopian London under constant government monitoring",
                    "ğŸ‘¥ Character: Winston Smith"
                ],
                "THE HOBBIT": [
                    "ğŸŒŸ A reluctant home-loving creature embarks on an unexpected adventure with thirteen companions",
                    "ğŸ‘¤ Author: British author, Tolkien",
                    "ğŸ“… Published: 1937",
                    "ğŸ­ Themes: Adventure, courage, greed, heroism from unlikely sources",
                    "ğŸ“– Setting: Middle-earth, including the Shire and Lonely Mountain",
                    "ğŸ‘¥ Character: Bilbo Baggins"
                ],
                "JANE EYRE": [
                    "ğŸŒŸ An orphaned governess faces a brooding employer with dark secrets",
                    "ğŸ‘¤ Author: British author, Charlotte BrontÃ«",
                    "ğŸ“… Published: 1847",
                    "ğŸ­ Themes: Independence, love vs. morality, social class, religion",
                    "ğŸ“– Setting: Yorkshire moors and Thornfield Hall in Victorian England",
                    "ğŸ‘¥ Character: Jane Eyre"
                ],
                "THE CATCHER IN THE RYE": [
                    "ğŸŒŸ A troubled teenager wanders New York City after being expelled from prep school",
                    "ğŸ‘¤ Author: American author, Salinger",
                    "ğŸ“… Published: 1951",
                    "ğŸ­ Themes: Alienation, loss of innocence, phoniness in adult world",
                    "ğŸ“– Setting: New York City in the 1950s",
                    "ğŸ‘¥ Character: Holden Caulfield"
                ],
                "MOBY DICK": [
                    "ğŸŒŸ A ship captain's obsessive quest for revenge against a white whale",
                    "ğŸ‘¤ Author: American author, Melville",
                    "ğŸ“… Published: 1851",
                    "ğŸ­ Themes: Obsession, fate vs. free will, nature's power, isolation",
                    "ğŸ“– Setting: Aboard a whaling ship sailing the world's oceans",
                    "ğŸ‘¥ Character: Captain Ahab"
                ],
                "WAR AND PEACE": [
                    "ğŸŒŸ Russian aristocratic families navigate love and loss during Napoleon's invasion",
                    "ğŸ‘¤ Author: Russian author, Tolstoy",
                    "ğŸ“… Published: 1869",
                    "ğŸ­ Themes: War's impact, fate, love, history's forces on individuals",
                    "ğŸ“– Setting: Russia during the Napoleonic Wars (1805-1820)",
                    "ğŸ‘¥ Character: Pierre Bezukhov"
                ],
                "THE LORD OF THE RINGS": [
                    "ğŸŒŸ A fellowship forms to destroy a ring that could doom their world",
                    "ğŸ‘¤ Author: British author, Tolkien",
                    "ğŸ“… Published: 1954-1955",
                    "ğŸ­ Themes: Good vs. evil, friendship, sacrifice, power's corruption",
                    "ğŸ“– Setting: Middle-earth, from the Shire to Mount Doom",
                    "ğŸ‘¥ Character: Frodo Baggins"
                ],
                "BRAVE NEW WORLD": [
                    "ğŸŒŸ In a future society of engineered happiness, one man questions the system",
                    "ğŸ‘¤ Author: British author, Huxley",
                    "ğŸ“… Published: 1932",
                    "ğŸ­ Themes: Technology's control, individuality vs. conformity, happiness vs. truth",
                    "ğŸ“– Setting: Futuristic World State society",
                    "ğŸ‘¥ Character: John the Savage"
                ],
                "WUTHERING HEIGHTS": [
                    "ğŸŒŸ A foundling's obsessive love spans generations on the Yorkshire moors",
                    "ğŸ‘¤ Author: British author, Emily BrontÃ«",
                    "ğŸ“… Published: 1847",
                    "ğŸ­ Themes: Destructive love, revenge, social class, nature vs. civilization",
                    "ğŸ“– Setting: Wuthering Heights and Thrushcross Grange on Yorkshire moors",
                    "ğŸ‘¥ Character: Heathcliff"
                ],
                "THE SCARLET LETTER": [
                    "ğŸŒŸ A woman bears shame and an illegitimate child in Puritan New England",
                    "ğŸ‘¤ Author: American author, Hawthorne",
                    "ğŸ“… Published: 1850",
                    "ğŸ­ Themes: Sin and redemption, guilt, hidden truth, social judgment",
                    "ğŸ“– Setting: Puritan Boston in the 1640s",
                    "ğŸ‘¥ Character: Hester Prynne"
                ],
                "LITTLE WOMEN": [
                    "ğŸŒŸ Four sisters grow up during the Civil War, facing poverty and personal challenges",
                    "ğŸ‘¤ Author: American author, Alcott",
                    "ğŸ“… Published: 1868",
                    "ğŸ­ Themes: Family bonds, women's roles, poverty vs. wealth, moral growth",
                    "ğŸ“– Setting: Concord, Massachusetts during the Civil War",
                    "ğŸ‘¥ Character: Jo March"
                ],
                "FRANKENSTEIN": [
                    "ğŸŒŸ A scientist creates life but abandons his creation with horrific consequences",
                    "ğŸ‘¤ Author: British author, Mary Shelley",
                    "ğŸ“… Published: 1818",
                    "ğŸ­ Themes: Scientific ethics, creation vs. responsibility, isolation, revenge",
                    "ğŸ“– Setting: Geneva, Switzerland and the Arctic",
                    "ğŸ‘¥ Character: Victor Frankenstein"
                ],
                "DRACULA": [
                    "ğŸŒŸ An ancient vampire travels to England to spread his curse",
                    "ğŸ‘¤ Author: Irish author, Stoker",
                    "ğŸ“… Published: 1897",
                    "ğŸ­ Themes: Good vs. evil, modernity vs. tradition, fear of the foreign",
                    "ğŸ“– Setting: Transylvania and Victorian England",
                    "ğŸ‘¥ Character: Count Dracula"
                ],
                "ALICE'S ADVENTURES IN WONDERLAND": [
                    "ğŸŒŸ A curious girl falls down a rabbit hole into a world of nonsense",
                    "ğŸ‘¤ Author: British author, Carroll",
                    "ğŸ“… Published: 1865",
                    "ğŸ­ Themes: Growing up, logic vs. nonsense, identity, authority",
                    "ğŸ“– Setting: Wonderland, a fantastical underground world",
                    "ğŸ‘¥ Character: Alice"
                ],
                "THE ADVENTURES OF HUCKLEBERRY FINN": [
                    "ğŸŒŸ A boy and an escaped slave travel down the Mississippi River seeking freedom",
                    "ğŸ‘¤ Author: American author, Twain",
                    "ğŸ“… Published: 1884",
                    "ğŸ­ Themes: Racism, moral growth, freedom vs. civilization, friendship",
                    "ğŸ“– Setting: Mississippi River in the antebellum American South",
                    "ğŸ‘¥ Character: Huckleberry Finn"
                ],
                "CRIME AND PUNISHMENT": [
                    "ğŸŒŸ A student commits murder and struggles with guilt and philosophical justification",
                    "ğŸ‘¤ Author: Russian author, Dostoyevsky",
                    "ğŸ“… Published: 1866",
                    "ğŸ­ Themes: Guilt and redemption, morality, poverty, psychological torment",
                    "ğŸ“– Setting: St. Petersburg, Russia in the 1860s",
                    "ğŸ‘¥ Character: Rodion Raskolnikov"
                ],
                "THE COUNT OF MONTE CRISTO": [
                    "ğŸŒŸ A wrongly imprisoned man escapes and methodically seeks revenge on his betrayers",
                    "ğŸ‘¤ Author: French author, Dumas",
                    "ğŸ“… Published: 1844",
                    "ğŸ­ Themes: Justice vs. revenge, forgiveness, transformation, hope",
                    "ğŸ“– Setting: France and Italy in the early 19th century",
                    "ğŸ‘¥ Character: Edmond DantÃ¨s"
                ],
                "ANNA KARENINA": [
                    "ğŸŒŸ A married aristocrat's affair leads to tragedy while others find happiness",
                    "ğŸ‘¤ Author: Russian author, Tolstoy",
                    "ğŸ“… Published: 1877",
                    "ğŸ­ Themes: Love vs. duty, society's constraints, faith, family",
                    "ğŸ“– Setting: Russian high society in the 1870s",
                    "ğŸ‘¥ Character: Anna Karenina"
                ],
                "THE PICTURE OF DORIAN GRAY": [
                    "ğŸŒŸ A young man's portrait ages while he remains beautiful but morally corrupt",
                    "ğŸ‘¤ Author: Irish author, Wilde",
                    "ğŸ“… Published: 1890",
                    "ğŸ­ Themes: Beauty vs. morality, hedonism, art's influence, corruption",
                    "ğŸ“– Setting: Victorian London",
                    "ğŸ‘¥ Character: Dorian Gray"
                ],
                "GREAT EXPECTATIONS": [
                    "ğŸŒŸ An orphan boy receives mysterious wealth and learns hard lessons about class",
                    "ğŸ‘¤ Author: British author, Dickens",
                    "ğŸ“… Published: 1861",
                    "ğŸ­ Themes: Social class, ambition vs. loyalty, love, personal growth",
                    "ğŸ“– Setting: Victorian England, London and the marshes of Kent",
                    "ğŸ‘¥ Character: Pip"
                ],
                "A TALE OF TWO CITIES": [
                    "ğŸŒŸ Love and sacrifice unfold against the backdrop of the French Revolution",
                    "ğŸ‘¤ Author: British author, Dickens",
                    "ğŸ“… Published: 1859",
                    "ğŸ­ Themes: Sacrifice, resurrection, duality, revolution's chaos",
                    "ğŸ“– Setting: London and Paris during the French Revolution",
                    "ğŸ‘¥ Character: Sydney Carton"
                ],
                "THE GRAPES OF WRATH": [
                    "ğŸŒŸ A family of farmers travels to California during the Great Depression",
                    "ğŸ‘¤ Author: American author, Steinbeck",
                    "ğŸ“… Published: 1939",
                    "ğŸ­ Themes: Social injustice, family unity, human dignity, survival",
                    "ğŸ“– Setting: Oklahoma to California during the Dust Bowl era",
                    "ğŸ‘¥ Character: Tom Joad"
                ],
                "OF MICE AND MEN": [
                    "ğŸŒŸ Two migrant workers dream of owning a farm during the Great Depression",
                    "ğŸ‘¤ Author: American author, Steinbeck",
                    "ğŸ“… Published: 1937",
                    "ğŸ­ Themes: Friendship, loneliness, dreams vs. reality, mercy",
                    "ğŸ“– Setting: California ranch during the Great Depression",
                    "ğŸ‘¥ Character: George Milton"
                ],
                "FAHRENHEIT 451": [
                    "ğŸŒŸ In a future where books are burned, a fireman begins to question his job",
                    "ğŸ‘¤ Author: American author, Bradbury",
                    "ğŸ“… Published: 1953",
                    "ğŸ­ Themes: Censorship, knowledge vs. ignorance, technology's impact, rebellion",
                    "ğŸ“– Setting: Dystopian future America",
                    "ğŸ‘¥ Character: Guy Montag"
                ],
                "LORD OF THE FLIES": [
                    "ğŸŒŸ British schoolboys stranded on an island descend into savagery",
                    "ğŸ‘¤ Author: British author, Golding",
                    "ğŸ“… Published: 1954",
                    "ğŸ­ Themes: Civilization vs. savagery, human nature, power, loss of innocence",
                    "ğŸ“– Setting: Uninhabited tropical island",
                    "ğŸ‘¥ Character: Ralph"
                ],
                "THE OLD MAN AND THE SEA": [
                    "ğŸŒŸ An aging fisherman battles a giant marlin in the Gulf Stream",
                    "ğŸ‘¤ Author: American author, Hemingway",
                    "ğŸ“… Published: 1952",
                    "ğŸ­ Themes: Perseverance, dignity in defeat, man vs. nature, isolation",
                    "ğŸ“– Setting: Cuban waters and the Gulf Stream",
                    "ğŸ‘¥ Character: Santiago"
                ]
            };
            
            return specificClues[book.title] || [
                "ğŸŒŸ A compelling story that has captivated readers for generations",
                `ğŸ‘¤ Author: ${book.author.split(' ').slice(-1)[0]}`,
                "ğŸ“… Era: Classic literature",
                "ğŸ­ Themes: Human nature and society",
                "ğŸ“– Setting: Various meaningful locations",
                "ğŸ‘¥ Features: Memorable characters"
            ];
        }

        // Game functions
        function loadGameHistory() {
            try {
                const saved = localStorage.getItem('shelflife-history');
                gameHistory = saved ? JSON.parse(saved) : {};
                
                const savedStats = localStorage.getItem('shelflife-stats');
                if (savedStats) {
                    playerStats = { ...playerStats, ...JSON.parse(savedStats) };
                }
                
                updateStatsDisplay();
            } catch (e) {
                gameHistory = {};
            }
        }

        function saveGameHistory() {
            try {
                localStorage.setItem('shelflife-history', JSON.stringify(gameHistory));
                localStorage.setItem('shelflife-stats', JSON.stringify(playerStats));
            } catch (e) {
                // localStorage not available
            }
        }

        function updateStatsDisplay() {
            document.getElementById('streak-count').textContent = playerStats.streak;
        }

        function updateCatalogLink(book) {
            const catalogLink = document.getElementById('catalog-link');
            if (book && book.isbn) {
                // Try to construct a more specific search URL with ISBN
                catalogLink.href = `https://southold-suffc.na.iiivega.com/search?query=${encodeURIComponent(book.isbn)}`;
            } else if (book) {
                // Fallback to title and author search
                const searchQuery = `${book.title} ${book.author}`.replace(/[^\w\s]/g, ' ').trim();
                catalogLink.href = `https://southold-suffc.na.iiivega.com/search?query=${encodeURIComponent(searchQuery)}`;
            } else {
                // Default catalog link
                catalogLink.href = 'https://southold-suffc.na.iiivega.com';
            }
        }

        function showClues() {
            const clues = generateClues(currentBook);
            const cluesContainer = document.getElementById('clues');
            cluesContainer.innerHTML = '';
            
            for (let i = 0; i < cluesShown; i++) {
                const clueDiv = document.createElement('div');
                clueDiv.className = 'clue';
                clueDiv.textContent = clues[i] || `Clue ${i + 1} not available`;
                cluesContainer.appendChild(clueDiv);
            }
            
            document.getElementById('clue-count').textContent = cluesShown;
        }

        function skipClue() {
            if (gameOver || cluesShown >= 6) return;
            
            guesses.push({ text: "(SKIPPED)", correct: false, isSkip: true });
            cluesShown = Math.min(6, cluesShown + 1);
            showClues();
            
            if (guesses.length >= 6) {
                gameOver = true;
                endGame(false);
            }
            
            displayGuesses();
            saveGameState();
        }

        function makeGuess() {
            if (gameOver) return;
            
            const input = document.getElementById('guess-input');
            const guess = input.value.trim();
            
            if (!guess) return;
            
            const isCorrect = titlesMatch(guess, currentBook.title);
            guesses.push({ text: guess.toUpperCase(), correct: isCorrect });
            
            input.value = '';
            
            if (isCorrect) {
                gameOver = true;
                playerStats.gamesPlayed++;
                playerStats.gamesWon++;
                playerStats.streak++;
                
                playSound('correct');
                setTimeout(() => playSound('win'), 500);
                
                checkAchievements(true);
                endGame(true);
            } else {
                playSound('incorrect');
                
                cluesShown = Math.min(6, cluesShown + 1);
                showClues();
                
                if (guesses.length >= 6) {
                    gameOver = true;
                    playerStats.gamesPlayed++;
                    playerStats.streak = 0;
                    endGame(false);
                }
            }
            
            displayGuesses();
            saveGameState();
        }

        function displayGuesses() {
            if (guesses.length === 0) return;
            
            document.getElementById('guesses-section').classList.remove('hidden');
            const guessesContainer = document.getElementById('guesses');
            guessesContainer.innerHTML = '';
            
            guesses.forEach(guess => {
                const guessDiv = document.createElement('div');
                if (guess.isSkip) {
                    guessDiv.className = 'guess skipped';
                } else {
                    guessDiv.className = `guess ${guess.correct ? 'correct' : 'incorrect'}`;
                }
                guessDiv.textContent = guess.text;
                guessesContainer.appendChild(guessDiv);
            });
            
            document.getElementById('guess-count').textContent = guesses.length;
        }

        function endGame(won = false) {
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            
            // Update catalog link with current book info
            updateCatalogLink(currentBook);
            
            const resultDiv = document.getElementById('result-text');
            if (won) {
                const actualGuesses = guesses.filter(g => !g.isSkip).length;
                resultDiv.innerHTML = `
                    <div class="result win">
                        <h3>ğŸ‰ Congratulations!</h3>
                        <p>You guessed "<strong>${currentBook.title}</strong>" by ${currentBook.author} in ${actualGuesses} guess${actualGuesses === 1 ? '' : 'es'}!</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="result lose">
                        <h3>ğŸ“š Better luck next time!</h3>
                        <p>The book was "<strong>${currentBook.title}</strong>" by ${currentBook.author}</p>
                    </div>
                `;
            }
            
            updateStatsDisplay();
        }

        function checkAchievements(won) {
            const achievements = [
                { id: "first_win", name: "First Victory", description: "Win your first game", emoji: "ğŸ‰" },
                { id: "streak_3", name: "Hot Streak", description: "Win 3 days in a row", emoji: "ğŸ”¥" },
                { id: "perfect_game", name: "Perfect Game", description: "Win with only 1 guess", emoji: "ğŸ’" },
                { id: "bookworm", name: "Bookworm", description: "Play 25 games", emoji: "ğŸ“š" }
            ];

            const newAchievements = [];
            
            if (won && !playerStats.achievements.includes('first_win') && playerStats.gamesWon === 1) {
                newAchievements.push('first_win');
            }
            
            if (won && guesses.filter(g => !g.isSkip).length === 1 && !playerStats.achievements.includes('perfect_game')) {
                newAchievements.push('perfect_game');
            }
            
            if (playerStats.streak >= 3 && !playerStats.achievements.includes('streak_3')) {
                newAchievements.push('streak_3');
            }
            
            if (playerStats.gamesPlayed >= 25 && !playerStats.achievements.includes('bookworm')) {
                newAchievements.push('bookworm');
            }
            
            newAchievements.forEach(achievementId => {
                if (!playerStats.achievements.includes(achievementId)) {
                    playerStats.achievements.push(achievementId);
                    showAchievement(achievementId, achievements);
                }
            });
        }

        function showAchievement(achievementId, achievementsList) {
            const achievement = achievementsList.find(a => a.id === achievementId);
            if (!achievement) return;
            
            const achievementEl = document.createElement('div');
            achievementEl.className = 'achievement';
            achievementEl.innerHTML = `
                <strong>${achievement.emoji} ${achievement.name}</strong><br>
                <span style="font-size: 14px;">${achievement.description}</span>
            `;
            
            document.getElementById('achievement-display').appendChild(achievementEl);
        }

        function shareResults() {
            const dateKey = getDateKey(selectedDate || new Date());
            const gameData = gameHistory[dateKey];
            
            if (!gameData) return;
            
            const dayNumber = getDayNumber();
            const guessEmojis = gameData.guesses.map(guess => {
                if (guess.isSkip) return 'â­ï¸';
                return guess.correct ? 'ğŸŸ©' : 'ğŸŸ¥';
            });
            
            while (guessEmojis.length < 6 && gameData.won) {
                guessEmojis.push('â¬œ');
            }
            
            const result = gameData.won ? `${guessEmojis.length}/6` : 'X/6';
            const shareText = `ğŸ“š Shelf Life #${dayNumber} ${result}\n\n${guessEmojis.join('')}\n\nğŸ”¥ Current streak: ${playerStats.streak}\n\nDaily book guessing game: ${window.location.href}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'âœ… Copied!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#10b981';
                    }, 2000);
                });
            } else {
                prompt('Copy this text to share:', shareText);
            }
        }

        function saveGameState() {
            const dateKey = getDateKey(selectedDate || new Date());
            gameHistory[dateKey] = {
                guesses: guesses,
                cluesShown: cluesShown,
                gameOver: gameOver,
                won: gameOver && guesses.some(g => g.correct),
                book: currentBook
            };
            saveGameHistory();
        }

        function loadGameState() {
            const dateKey = getDateKey(selectedDate || new Date());
            const savedGame = gameHistory[dateKey];
            
            if (savedGame) {
                guesses = savedGame.guesses || [];
                cluesShown = savedGame.cluesShown || 1;
                gameOver = savedGame.gameOver || false;
                
                displayGuesses();
                if (gameOver) {
                    endGame(savedGame.won);
                }
            } else {
                guesses = [];
                cluesShown = 1;
                gameOver = false;
            }
        }

        function showArchiveList() {
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('archive-section').classList.remove('hidden');
            
            const archiveList = document.getElementById('archive-list');
            archiveList.innerHTML = '';
            
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const dateKey = getDateKey(date);
                const dayData = gameHistory[dateKey];
                const isToday = dateKey === getDateKey(new Date());
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `archive-day ${dayData && dayData.won ? 'completed' : ''} ${isToday ? 'current' : ''}`;
                
                const statusIcon = dayData && dayData.won ? 'âœ…' : dayData && dayData.gameOver ? 'âŒ' : 'â³';
                
                let bookInfo = '';
                if (dayData && dayData.gameOver && dayData.book) {
                    bookInfo = `<p class="archive-book">${dayData.book.title} by ${dayData.book.author}</p>`;
                } else if (isToday) {
                    bookInfo = `<p class="archive-book">Today's puzzle</p>`;
                } else {
                    bookInfo = `<p class="archive-book">Click to play</p>`;
                }
                
                dayDiv.innerHTML = `
                    <div class="archive-info">
                        <h4>${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} ${isToday ? '(Today)' : ''}</h4>
                        ${bookInfo}
                    </div>
                    <div class="archive-status">${statusIcon}</div>
                `;
                
                dayDiv.onclick = () => playArchiveDay(date);
                archiveList.appendChild(dayDiv);
            }
        }

        function showTodaysGame() {
            selectedDate = null;
            document.getElementById('archive-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            initGame();
        }

        function playArchiveDay(date) {
            selectedDate = date;
            document.getElementById('archive-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            initGame();
        }

        function resetGameUI() {
            document.getElementById('guesses-section').classList.add('hidden');
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('guess-input').value = '';
            document.getElementById('achievement-display').innerHTML = '';
            
            // Remove any lingering lightbulb text
            const inputSection = document.getElementById('input-section');
            const paragraphs = inputSection.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (p.textContent.includes('ğŸ’¡') || p.textContent.includes('Skipping') || p.textContent.includes('clue')) {
                    p.remove();
                }
            });
        }

        function initGame() {
            if (books.length === 0) {
                console.log('No books loaded yet');
                return;
            }
            
            loadGameHistory();
            currentBook = getTodaysBook();
            showCurrentDate();
            resetGameUI();
            loadGameState();
            showClues();
            updateStatsDisplay();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadGameHistory();
            
            document.getElementById('guess-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    makeGuess();
                }
            });
        });

        // Auto-refresh books daily at midnight
        function scheduleBookRefresh() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 1, 0, 0); // 12:01 AM tomorrow
            
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            
            setTimeout(() => {
                loadBooksFromSheet().then(loadedBooks => {
                    books = loadedBooks;
                    if (!selectedDate) {
                        initGame(); // Refresh today's game
                    }
                });
                
                // Set up daily refresh
                setInterval(() => {
                    loadBooksFromSheet().then(loadedBooks => {
                        books = loadedBooks;
                        if (!selectedDate) {
                            initGame();
                        }
                    });
                }, 24 * 60 * 60 * 1000); // Every 24 hours
                
            }, msUntilMidnight);
        }

        // Start the refresh scheduler
        scheduleBookRefresh();
    </script>
</body>
</html>
