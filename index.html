<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Checked Out | Southold Free Library</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px; margin: 0 auto; padding: 20px;
      background: linear-gradient(135deg, #4A90A4 0%, #5BA4B8 100%);
      min-height: 100vh;
    }

    /* Enhanced Library Card Styling */
    .library-card {
      background: #F5F3E7;
      background-image: 
        /* Coffee stains */
        radial-gradient(ellipse 40px 30px at 85% 15%, rgba(139, 117, 90, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 25px 35px at 15% 85%, rgba(156, 130, 95, 0.12) 0%, transparent 60%),
        /* Paper texture */
        radial-gradient(circle at 20% 50%, rgba(139, 117, 90, 0.08) 1px, transparent 2px),
        radial-gradient(circle at 40% 20%, rgba(156, 130, 95, 0.06) 1px, transparent 2px),
        radial-gradient(circle at 90% 80%, rgba(139, 117, 90, 0.05) 1px, transparent 2px),
        radial-gradient(circle at 60% 60%, rgba(139, 117, 90, 0.04) 1px, transparent 2px);
      border: 2px solid #D4C5A9;
      border-radius: 8px;
      box-shadow: 
        0 8px 16px rgba(0, 0, 0, 0.15),
        0 2px 4px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 2px 2px 4px rgba(139, 117, 90, 0.05);
      padding: 20px;
      margin-bottom: 15px;
      position: relative;
    }

    /* Enhanced ruled lines */
    .library-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        transparent,
        transparent 24px,
        rgba(139, 117, 90, 0.12) 24px,
        rgba(139, 117, 90, 0.12) 25px
      );
      pointer-events: none;
      border-radius: 6px;
    }

    /* Library card holes */
    .library-card::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 8px;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, rgba(139, 117, 90, 0.3) 0%, transparent 70%);
      border-radius: 50%;
      transform: translateY(-50%);
      box-shadow: 
        0 -30px 0 rgba(139, 117, 90, 0.2),
        0 30px 0 rgba(139, 117, 90, 0.2);
    }

    .card-header {
      text-align: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #8B755A;
      padding-bottom: 15px;
      position: relative;
      z-index: 2;
    }

    .library-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      letter-spacing: 1px;
      color: #5A4A3A;
      margin-bottom: 5px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .game-title {
      font-family: 'Inter', sans-serif;
      font-size: 2.2rem;
      font-weight: 700;
      color: #2D2D2D;
      margin: 5px 0;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .subtitle {
      font-family: 'Inter', sans-serif;
      font-style: italic;
      color: #5A4A3A;
      font-size: 0.9rem;
      margin: 0;
    }

    /* Enhanced checkout info with due date stamp look */
    .checkout-info {
      display: flex;
      justify-content: space-between;
      margin: 15px 0;
      padding: 12px;
      background: rgba(255, 255, 255, 0.4);
      border: 2px dashed #8B755A;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      position: relative;
      z-index: 2;
    }

    .checkout-info::before {
      content: 'DUE DATE';
      position: absolute;
      top: -8px;
      right: 20px;
      background: #F5F3E7;
      padding: 0 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      color: #DC2626;
      font-weight: bold;
      letter-spacing: 1px;
      transform: rotate(-1deg);
    }

    .due-date {
      font-weight: 700;
      color: #1E3A8A;
    }

    .stats-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: nowrap;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid #D4C5A9;
      border-radius: 4px;
      padding: 8px 12px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      min-width: 100px;
      position: relative;
      z-index: 2;
    }

    .stat-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: #5A4A3A;
      margin-bottom: 2px;
    }

    .stat-value {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      color: #2D2D2D;
      font-size: 1rem;
    }

    .nav-stamps {
      text-align: center;
      margin: 20px 0;
    }

    .stamp-btn {
      font-family: 'JetBrains Mono', monospace;
      background: #DC2626;
      color: white;
      border: 3px solid #991B1B;
      border-radius: 4px;
      padding: 10px 16px;
      margin: 0 10px 10px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      transform: rotate(-1deg);
      box-shadow: 
        0 3px 6px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.2s ease;
      position: relative;
      min-height: 48px;
    }

    .stamp-btn::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 1px dashed rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      pointer-events: none;
    }

    .stamp-btn:hover {
      transform: rotate(0deg) translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .stamp-btn:nth-child(2) {
      transform: rotate(1deg);
      background: #059669;
      border-color: #047857;
    }

    .card-section {
      position: relative;
      z-index: 2;
      margin-bottom: 20px;
    }

    .section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: #5A4A3A;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .clues-list {
      margin: 15px 0;
    }

    .clue-entry {
      background: rgba(255, 255, 255, 0.3);
      border-left: 4px solid #1E3A8A;
      padding: 12px;
      margin: 8px 0;
      border-radius: 0 4px 4px 0;
      font-family: 'Inter', sans-serif;
      color: #2D2D2D;
      position: relative;
      z-index: 2;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transform: translateY(10px);
      opacity: 0;
      animation: slideUp 0.4s ease-out forwards;
    }

    .clue-entry:nth-child(1) { animation-delay: 0.1s; }
    .clue-entry:nth-child(2) { animation-delay: 0.2s; }
    .clue-entry:nth-child(3) { animation-delay: 0.3s; }
    .clue-entry:nth-child(4) { animation-delay: 0.4s; }
    .clue-entry:nth-child(5) { animation-delay: 0.5s; }
    .clue-entry:nth-child(6) { animation-delay: 0.6s; }

    @keyframes slideUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Enhanced input section */
    .input-section {
      background: rgba(255, 255, 255, 0.4);
      border: 2px dashed #8B755A;
      border-radius: 6px;
      padding: 15px;
      margin: 15px 0;
      position: relative;
      z-index: 2;
    }

    .input-section::before {
      content: 'PATRON INPUT';
      position: absolute;
      top: -8px;
      left: 20px;
      background: #F5F3E7;
      padding: 0 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      color: #5A4A3A;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .guess-feedback {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }

    .feedback-correct {
      background: rgba(5, 150, 105, 0.2);
      border: 1px solid #059669;
      color: #065F46;
    }

    .feedback-incorrect {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid #DC2626;
      color: #991B1B;
    }

    .feedback-hidden {
      display: none;
    }

    .guess-input {
      flex: 1;
      padding: 10px;
      border: 2px solid #8B755A;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      background: rgba(255, 255, 255, 0.9);
      color: #2D2D2D;
      font-size: 14px;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
      min-height: 48px;
    }

    .guess-input:focus {
      outline: none;
      border-color: #1E3A8A;
      box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.2);
    }

    .action-btn {
      padding: 16px 20px;
      border: none;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 1.2rem;
      min-width: 60px;
      min-height: 48px;
    }

    .submit-btn {
      background: #059669;
      color: white;
    }

    .submit-btn:hover {
      background: #047857;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .skip-btn {
      background: #DC2626;
      color: white;
    }

    .skip-btn:hover {
      background: #B91C1C;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .guesses-log {
      margin: 15px 0;
    }

    .guess-entry {
      padding: 10px 12px;
      margin: 6px 0;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      position: relative;
      z-index: 2;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .guess-correct {
      background: rgba(5, 150, 105, 0.2);
      border-left: 4px solid #059669;
      color: #065F46;
    }

    .guess-incorrect {
      background: rgba(220, 38, 38, 0.2);
      border-left: 4px solid #DC2626;
      color: #991B1B;
    }

    .guess-skipped {
      background: rgba(156, 163, 175, 0.2);
      border-left: 4px solid #9CA3AF;
      color: #6B7280;
      font-style: italic;
    }

    .result-stamp {
      text-align: center;
      padding: 20px;
      margin: 20px 0;
      position: relative;
      z-index: 2;
      border-radius: 8px;
    }

    .win-stamp {
      background: rgba(5, 150, 105, 0.2);
      border: 3px solid #059669;
      color: #065F46;
      transform: rotate(-2deg);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .lose-stamp {
      background: rgba(220, 38, 38, 0.2);
      border: 3px solid #DC2626;
      color: #991B1B;
      transform: rotate(1deg);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .final-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
      gap: 10px;
      margin: 15px 0;
      position: relative;
      z-index: 2;
    }

    .final-stat {
      text-align: center;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid #D4C5A9;
      border-radius: 4px;
      padding: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .final-stat-number {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: #2D2D2D;
    }

    .final-stat-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      color: #5A4A3A;
      text-transform: uppercase;
    }

    .share-section {
      text-align: center;
      margin: 15px 0;
      position: relative;
      z-index: 2;
    }

    .share-btn {
      font-family: 'JetBrains Mono', monospace;
      background: #1E3A8A;
      color: white;
      border: 2px solid #1E40AF;
      border-radius: 6px;
      padding: 12px 20px;
      margin: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      min-height: 48px;
    }

    .share-btn:hover {
      background: #1E40AF;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Enhanced library info with catalog card styling */
    .library-info {
      background: rgba(255, 255, 255, 0.4);
      border: 2px solid #D4C5A9;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      margin: 15px 0;
      position: relative;
      z-index: 2;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .library-info::before {
      content: 'CATALOG REFERENCE';
      position: absolute;
      top: -8px;
      left: 20px;
      background: #F5F3E7;
      padding: 0 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      color: #5A4A3A;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .library-info a {
      font-family: 'JetBrains Mono', monospace;
      background: #1E3A8A;
      color: white;
      padding: 8px 16px;
      text-decoration: none;
      border-radius: 4px;
      font-weight: 600;
      display: inline-block;
      margin-top: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }

    .library-info a:hover {
      background: #1E40AF;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Enhanced countdown with library stamp styling */
    .countdown-card {
      background: rgba(255, 255, 255, 0.4);
      border: 2px dashed #8B755A;
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      margin: 20px 0;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .countdown-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: #5A4A3A;
      margin-bottom: 5px;
    }

    .countdown-time {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: #2D2D2D;
    }

    .footer {
      text-align: center;
      padding: 15px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.8rem;
    }

    .footer a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-weight: 600;
    }

    .hidden { display: none; }

    /* Mobile Responsive */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .game-title { font-size: 1.8rem; }
      .checkout-info { flex-direction: column; gap: 5px; }
      .stats-row { flex-wrap: nowrap; }
      .stamp-btn { 
        display: block; 
        width: 90%; 
        margin: 8px auto; 
        transform: rotate(0deg);
        min-height: 48px;
        font-size: 0.9rem;
      }
      
      .input-group { 
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      
      .guess-input { 
        width: 100%;
        padding: 14px; 
        font-size: 16px;
        min-height: 48px;
        order: 1;
      }
      
      .mobile-buttons {
        display: flex;
        gap: 10px;
        order: 2;
      }
      
      .action-btn { 
        flex: 1;
        padding: 14px;
        min-height: 48px;
        font-size: 1.1rem;
      }
      
      .final-stats { 
        grid-template-columns: repeat(2, 1fr); 
      }
      
      .share-btn {
        width: 90%;
        margin: 8px auto;
        display: block;
        padding: 14px;
        min-height: 48px;
      }
    }
  </style>
</head>
<body>
  <!-- Header Card -->
  <div class="library-card">
    <div class="card-header">
      <div class="library-label">SOUTHOLD FREE LIBRARY</div>
      <div class="game-title">Checked Out</div>
      <div class="subtitle">Daily Book Guessing Game</div>
    </div>
    
    <div class="checkout-info">
      <div>
        <strong>GAME:</strong> <span id="gameNumber" class="due-date">#001</span>
      </div>
      <div>
        <strong>ISSUED:</strong> <span id="currentDate" class="due-date">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Stats Card -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">STREAK</div>
      <div class="stat-value">🔥 <span id="streakCount">0</span></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">THEME</div>
      <div class="stat-value" id="themeHint">📖 Loading...</div>
    </div>
  </div>

  <!-- Navigation Stamps -->
  <div class="nav-stamps">
    <button class="stamp-btn" id="todayBtn">📅 TODAY'S GAME</button>
    <button class="stamp-btn" id="archiveBtn">🗂️ ARCHIVE</button>
  </div>

  <!-- Game Section -->
  <div id="gameSection">
    <!-- Clues Card -->
    <div class="library-card">
      <div class="card-section">
        <div class="section-title">📋 Clues (<span id="clueCount">1</span>/6)</div>
        <div class="clues-list" id="cluesContainer"></div>
      </div>
    </div>

    <!-- Input Card -->
    <div class="library-card" id="inputSection">
      <div class="input-section">
        <div class="section-title">Your Guess</div>
        <div class="input-group">
          <input type="text" class="guess-input" id="guessInput" placeholder="Enter book title...">
          <div class="mobile-buttons">
            <button class="action-btn submit-btn" id="submitBtn">→</button>
            <button class="action-btn skip-btn" id="skipBtn">✕</button>
          </div>
        </div>
        <div class="guess-feedback feedback-hidden" id="guessFeedback"></div>
      </div>
    </div>

    <!-- Guesses Card -->
    <div class="library-card hidden" id="guessesSection">
      <div class="card-section">
        <div class="section-title">Your Guesses (<span id="guessCount">0</span>/6)</div>
        <div class="guesses-log" id="guessesContainer"></div>
      </div>
    </div>

    <!-- Results Card -->
    <div class="library-card hidden" id="resultSection">
      <div id="resultText"></div>
      
      <div class="final-stats">
        <div class="final-stat">
          <div class="final-stat-number" id="gamesPlayed">0</div>
          <div class="final-stat-label">Played</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-number" id="winPercent">0%</div>
          <div class="final-stat-label">Win %</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-number" id="currentStreak">0</div>
          <div class="final-stat-label">Current</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-number" id="maxStreak">0</div>
          <div class="final-stat-label">Max</div>
        </div>
      </div>
      
      <div class="share-section">
        <button class="share-btn" id="nativeShareBtn" style="display:none;">📤 SHARE</button>
        <button class="share-btn" id="shareBtn">📋 COPY RESULTS</button>
      </div>
      
      <div class="library-info">
        <strong>📖 Find this book at Southold Free Library</strong><br>
        <a href="#" id="catalogLink" target="_blank">Search Our Catalog</a>
      </div>
    </div>
  </div>

  <!-- Archive Section -->
  <div class="library-card hidden" id="archiveSection">
    <div class="card-section">
      <div class="section-title">🗂️ Game Archive</div>
      <div id="archiveList"></div>
    </div>
  </div>

  <!-- Countdown Card -->
  <div class="countdown-card">
    <div class="countdown-label">⏰ NEXT GAME IN</div>
    <div class="countdown-time" id="countdownTime">--:--:--</div>
  </div>

  <div class="footer">
    <p>Powered by <a href="https://southoldlibrary.org" target="_blank">Southold Free Library</a></p>
  </div>

<script>
const gameData = {
  books: [
    {
      id: 1,
      date: "2025-08-21",
      title: "NINETEEN EIGHTY-FOUR",
      author: "George Orwell",
      year: 1949,
      genre: "Dystopian Fiction",
      tags: ["surveillance", "totalitarianism", "classic"],
      difficulty: "Medium",
      theme: "Dystopian Fiction", // Keep for backward compatibility
      clues: [
        "In a surveillance state where Big Brother watches all",
        "Author: British author, Orwell", 
        "Published: 1949",
        "Themes: Totalitarianism, surveillance, truth manipulation, individual freedom",
        "Setting: Dystopian London under constant government monitoring",
        "Character: Winston Smith"
      ],
      catalogUrl: "https://southold-suffc.na.iiivega.com/search/title?query=nineteen%20eighty%20four"
    },
    {
      id: 2,
      date: "2025-08-22",
      title: "THE GREAT GATSBY",
      author: "F. Scott Fitzgerald",
      year: 1925,
      genre: "American Literature", 
      tags: ["jazz-age", "american-dream", "classic"],
      difficulty: "Easy",
      theme: "American Literature",
      clues: [
        "Tobey Maguire played Nick in the 2013 film adaptation",
        "The green light symbolizes unreachable desire",
        "Set in the glittering Jazz Age",
        "Entered public domain in 2021", 
        "A 1925 novel about chasing the American Dream",
        "Main character: Jay Gatsby"
      ],
      catalogUrl: "https://southold-suffc.na.iiivega.com/search/title?query=great%20gatsby"
    },
    {
      id: 3,
      date: "2025-08-23",
      title: "THE 48 LAWS OF POWER",
      author: "Robert Greene",
      year: 1998,
      genre: "Self-Help",
      tags: ["strategy", "influence", "psychology"],
      difficulty: "Hard",
      theme: "Self-Help",
      clues: [
        "A numbered guide to mastering influence",
        "Uses stories of Napoleon, Cleopatra, Sun Tzu",
        "The most banned book in U.S. prisons",
        "Published in 1998, still a bestseller",
        "Known as the 'Machiavellian Bible'",
        "Author: Robert Greene"
      ],
      catalogUrl: "https://southold-suffc.na.iiivega.com/search/title?query=48%20laws%20power"
    },
    {
      id: 4,
      date: "2025-08-24",
      title: "EVERYTHING IS TUBERCULOSIS", 
      author: "John Green",
      year: 2025,
      genre: "Nonfiction",
      tags: ["medical-history", "science", "humor"],
      difficulty: "Medium",
      theme: "Nonfiction",
      clues: [
        "A 2025 nonfiction book about TB (infectious disease)",
        "Blends medical history with personal reflections",
        "Explores the world's oldest bacterial disease", 
        "Written by John Green (The Fault in Our Stars)",
        "Connects science, humor, and humanity",
        "Narrator: John Green"
      ],
      catalogUrl: "https://southold-suffc.na.iiivega.com/search/title?query=everything%20tuberculosis"
    },
    {
      id: 5,
      date: "2025-08-25",
      title: "TO KILL A MOCKINGBIRD",
      author: "Harper Lee",
      year: 1960,
      genre: "Social Justice",
      tags: ["civil-rights", "coming-of-age", "pulitzer"],
      difficulty: "Easy",
      theme: "Social Justice",
      clues: [
        "A trial divides a small Alabama town",
        "Explores justice, innocence, and prejudice",
        "Won the Pulitzer Prize in 1961", 
        "Frequently challenged in schools",
        "Published in 1960, set in 1930s Alabama",
        "Narrator: Scout Finch"
      ],
      catalogUrl: "https://southold-suffc.na.iiivega.com/search/title?query=kill%20mockingbird"
    }
  ],
  
  currentBook: null,
  guesses: [],
  cluesShown: 1,
  gameOver: false,
  selectedDate: null,
  gameHistory: {},
  playerStats: {
    streak: 0,
    gamesPlayed: 0, 
    gamesWon: 0,
    maxStreak: 0,
    lastPlayDate: null
  }
};

function getTodayNY() {
  return new Date().toLocaleDateString('en-CA', {timeZone: 'America/New_York'});
}

function getTodaysBook() {
  const targetDate = gameData.selectedDate || getTodayNY();
  const book = gameData.books.find(b => b.date === targetDate);
  if (book) return book;
  
  const dayNum = Math.max(1, Math.floor((new Date() - new Date('2025-08-21')) / 86400000) + 1);
  const index = (dayNum - 1) % gameData.books.length;
  return gameData.books[index];
}

function updateDisplay() {
  gameData.currentBook = getTodaysBook();
  
  const today = gameData.selectedDate ? new Date(gameData.selectedDate + 'T12:00:00') : new Date();
  document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', {
    timeZone: 'America/New_York',
    month: 'short',
    day: 'numeric', 
    year: 'numeric'
  });
  
  const dayNum = gameData.selectedDate ? 
    gameData.books.findIndex(b => b.date === gameData.selectedDate) + 1 :
    Math.max(1, Math.floor((new Date() - new Date('2025-08-21')) / 86400000) + 1);
  
  document.getElementById('gameNumber').textContent = '#' + String(dayNum).padStart(3, '0');
  document.getElementById('themeHint').textContent = '📖 ' + gameData.currentBook.theme;
  document.getElementById('streakCount').textContent = gameData.playerStats.streak;
}

function showClues() {
  const container = document.getElementById('cluesContainer');
  container.innerHTML = '';
  
  for (let i = 0; i < gameData.cluesShown; i++) {
    if (gameData.currentBook.clues[i]) {
      const clueDiv = document.createElement('div');
      clueDiv.className = 'clue-entry';
      clueDiv.textContent = gameData.currentBook.clues[i];
      container.appendChild(clueDiv);
    }
  }
  
  document.getElementById('clueCount').textContent = gameData.cluesShown;
}

function displayGuesses() {
  const container = document.getElementById('guessesContainer');
  const section = document.getElementById('guessesSection');
  
  if (gameData.guesses.length === 0) {
    section.classList.add('hidden');
    return;
  }
  
  section.classList.remove('hidden');
  container.innerHTML = '';
  
  gameData.guesses.forEach(guess => {
    const div = document.createElement('div');
    div.className = 'guess-entry guess-' + (guess.isSkip ? 'skipped' : (guess.correct ? 'correct' : 'incorrect'));
    div.textContent = guess.text;
    container.appendChild(div);
  });
  
  document.getElementById('guessCount').textContent = gameData.guesses.length;
}

function normalizeTitle(str) {
  return str.toUpperCase()
    .replace(/[^\w\s]/g, ' ')
    .replace(/\s+/g, ' ')
    .replace(/\b(THE|A|AN|TO|OF|AND|IN|ON|AT|BY|FOR|WITH|FROM|IS|ARE|WAS|WERE)\b/g, '')
    // Enhanced number conversions - both ways for better matching
    .replace(/\bZERO\b/g, '0').replace(/\b0\b/g, 'ZERO')
    .replace(/\bONE\b/g, '1').replace(/\b1\b/g, 'ONE')
    .replace(/\bTWO\b/g, '2').replace(/\b2\b/g, 'TWO')
    .replace(/\bTHREE\b/g, '3').replace(/\b3\b/g, 'THREE')
    .replace(/\bFOUR\b/g, '4').replace(/\b4\b/g, 'FOUR')
    .replace(/\bFIVE\b/g, '5').replace(/\b5\b/g, 'FIVE')
    .replace(/\bSIX\b/g, '6').replace(/\b6\b/g, 'SIX')
    .replace(/\bSEVEN\b/g, '7').replace(/\b7\b/g, 'SEVEN')
    .replace(/\bEIGHT\b/g, '8').replace(/\b8\b/g, 'EIGHT')
    .replace(/\bNINE\b/g, '9').replace(/\b9\b/g, 'NINE')
    .replace(/\bTEN\b/g, '10').replace(/\b10\b/g, 'TEN')
    // Handle compound numbers for books like "1984"
    .replace(/\bNINETEEN EIGHTY FOUR\b/g, '1984')
    .replace(/\b1984\b/g, 'NINETEEN EIGHTY FOUR')
    .replace(/\bTWENTY TWENTY\b/g, '2020')
    .replace(/\b2020\b/g, 'TWENTY TWENTY')
    .replace(/\bTWO THOUSAND\b/g, '2000')
    .replace(/\b2000\b/g, 'TWO THOUSAND')
    // Handle other common book numbers
    .replace(/\bFORTY EIGHT\b/g, '48')
    .replace(/\b48\b/g, 'FORTY EIGHT')
    .replace(/\bFIFTY\b/g, '50').replace(/\b50\b/g, 'FIFTY')
    .replace(/\bHUNDRED\b/g, '100').replace(/\b100\b/g, 'HUNDRED')
    .trim();
}

function checkGuess(guess) {
  const normalizedGuess = normalizeTitle(guess);
  const normalizedTitle = normalizeTitle(gameData.currentBook.title);
  
  if (normalizedGuess === normalizedTitle) return true;
  
  const guessWords = normalizedGuess.split(' ').filter(w => w.length > 2);
  const titleWords = normalizedTitle.split(' ').filter(w => w.length > 2);
  
  if (titleWords.length === 0) return false;
  
  const matchedWords = titleWords.filter(word => 
    guessWords.some(guessWord => 
      guessWord.includes(word) || word.includes(guessWord)
    )
  );
  
  return matchedWords.length >= Math.max(1, Math.ceil(titleWords.length * 0.7));
}

function submitGuess() {
  const input = document.getElementById('guessInput');
  const feedback = document.getElementById('guessFeedback');
  const guess = input.value.trim();
  
  if (!guess || gameData.gameOver) return;
  
  const isCorrect = checkGuess(guess);
  gameData.guesses.push({ text: guess, correct: isCorrect, isSkip: false });
  
  if (feedback) {
    // Clear any existing feedback classes and timers
    feedback.classList.remove('feedback-hidden', 'feedback-correct', 'feedback-incorrect');
    
    if (isCorrect) {
      feedback.classList.add('feedback-correct');
      feedback.textContent = '✅ Correct! Book found!';
      
      // Auto-hide feedback and end game
      setTimeout(() => {
        feedback.classList.add('feedback-hidden');
        endGame(true);
      }, 2000);
    } else {
      feedback.classList.add('feedback-incorrect');
      feedback.textContent = `❌ Not quite right. Try again!`;
      
      if (gameData.guesses.length >= 6) {
        setTimeout(() => {
          feedback.classList.add('feedback-hidden');
          endGame(false);
        }, 2000);
      } else {
        gameData.cluesShown = Math.min(6, gameData.cluesShown + 1);
        setTimeout(() => {
          showClues();
          // Auto-hide feedback after showing new clue
          feedback.classList.add('feedback-hidden');
        }, 1500);
      }
    }
  }
  
  displayGuesses();
  input.value = '';
  saveGameState();
}

function skipClue() {
  if (gameData.gameOver) return;
  
  const feedback = document.getElementById('guessFeedback');
  
  gameData.guesses.push({ text: '(skipped)', correct: false, isSkip: true });
  
  if (feedback) {
    feedback.classList.remove('feedback-hidden', 'feedback-correct', 'feedback-incorrect');
    feedback.classList.add('feedback-incorrect');
    feedback.textContent = '⏭️ Clue skipped';
    
    if (gameData.guesses.length >= 6) {
      setTimeout(() => {
        feedback.classList.add('feedback-hidden');
        endGame(false);
      }, 2000);
    } else {
      gameData.cluesShown = Math.min(6, gameData.cluesShown + 1);
      setTimeout(() => {
        showClues();
        // Auto-hide feedback after showing new clue
        feedback.classList.add('feedback-hidden');
      }, 1500);
    }
  }
  
  displayGuesses();
  saveGameState();
}

function endGame(won) {
  gameData.gameOver = true;
  
  gameData.playerStats.gamesPlayed++;
  if (won) {
    gameData.playerStats.gamesWon++;
    gameData.playerStats.streak++;
    gameData.playerStats.maxStreak = Math.max(gameData.playerStats.maxStreak, gameData.playerStats.streak);
  } else {
    gameData.playerStats.streak = 0;
  }
  
  gameData.playerStats.lastPlayDate = getTodayNY();
  
  const gameDate = gameData.selectedDate || getTodayNY();
  gameData.gameHistory[gameDate] = {
    won: won,
    guesses: [...gameData.guesses],
    cluesUsed: gameData.cluesShown
  };
  
  showResults(won);
  document.getElementById('inputSection').classList.add('hidden');
  
  saveGameState();
}

function showResults(won) {
  const resultSection = document.getElementById('resultSection');
  const resultText = document.getElementById('resultText');
  
  if (won) {
    resultText.innerHTML = `
      <div class="result-stamp win-stamp">
        <h2>🎉 Great Job! 🎉</h2>
        <p><strong>"${gameData.currentBook.title}"</strong><br>
        by ${gameData.currentBook.author} (${gameData.currentBook.year})</p>
        <p>Found in ${gameData.guesses.length}/6 guesses!</p>
        <p><em>Genre: ${gameData.currentBook.genre}</em></p>
      </div>
    `;
  } else {
    resultText.innerHTML = `
      <div class="result-stamp lose-stamp">
        <h2>📋 OVERDUE NOTICE 📋</h2>
        <p>The book was:<br>
        <strong>"${gameData.currentBook.title}"</strong><br>
        by ${gameData.currentBook.author} (${gameData.currentBook.year})</p>
        <p><em>Genre: ${gameData.currentBook.genre}</em></p>
        <p>Better luck tomorrow!</p>
      </div>
    `;
  }
  
  document.getElementById('gamesPlayed').textContent = gameData.playerStats.gamesPlayed;
  document.getElementById('winPercent').textContent = Math.round((gameData.playerStats.gamesWon / gameData.playerStats.gamesPlayed) * 100) + '%';
  document.getElementById('currentStreak').textContent = gameData.playerStats.streak;
  document.getElementById('maxStreak').textContent = gameData.playerStats.maxStreak;
  
  const catalogLink = document.getElementById('catalogLink');
  // Use pre-built catalog URL if available, otherwise construct it
  if (gameData.currentBook.catalogUrl) {
    catalogLink.href = gameData.currentBook.catalogUrl;
  } else {
    const searchQuery = encodeURIComponent(gameData.currentBook.title);
    catalogLink.href = `https://southold-suffc.na.iiivega.com/search/title?query=${searchQuery}`;
  }
  catalogLink.target = '_blank';
  
  resultSection.classList.remove('hidden');
}

function generateShareText() {
  const gameDate = gameData.selectedDate || getTodayNY();
  const dayNum = gameData.selectedDate ? 
    gameData.books.findIndex(b => b.date === gameData.selectedDate) + 1 :
    Math.max(1, Math.floor((new Date() - new Date('2025-08-21')) / 86400000) + 1);
  
  const won = gameData.gameHistory[gameDate]?.won || false;
  const guessCount = gameData.guesses.length;
  
  let shareText = `Checked Out #${dayNum} ${won ? guessCount : 'X'}/6\n`;
  
  if (won) {
    shareText += `Solved in ${guessCount} clue${guessCount > 1 ? 's' : ''} ✅\n\n`;
  } else {
    shareText += `Better luck tomorrow! 📚\n\n`;
  }
  
  gameData.guesses.forEach(guess => {
    if (guess.isSkip) {
      shareText += '⬜ ';
    } else if (guess.correct) {
      shareText += '🟩 ';
    } else {
      shareText += '🟥 ';
    }
  });
  
  shareText += '\n\nPlay here: https://shelf-life-beta.vercel.app';
  return shareText;
}

function shareResults() {
  const shareText = generateShareText();
  
  if (navigator.share && /Mobi|Android/i.test(navigator.userAgent)) {
    navigator.share({
      title: 'Checked Out - Southold Free Library',
      text: shareText
    });
  } else {
    navigator.clipboard.writeText(shareText).then(() => {
      const btn = document.getElementById('shareBtn');
      const originalText = btn.textContent;
      btn.textContent = '✅ COPIED!';
      setTimeout(() => btn.textContent = originalText, 2000);
    });
  }
}

function showArchive() {
  const archiveSection = document.getElementById('archiveSection');
  const archiveList = document.getElementById('archiveList');
  const gameSection = document.getElementById('gameSection');
  
  gameSection.classList.add('hidden');
  archiveSection.classList.remove('hidden');
  
  archiveList.innerHTML = '';
  
  gameData.books.forEach((book, index) => {
    const gameDate = book.date;
    const history = gameData.gameHistory[gameDate];
    
    const archiveItem = document.createElement('div');
    archiveItem.className = 'clue-entry';
    archiveItem.style.cursor = 'pointer';
    
    const status = history ? (history.won ? '🟩' : '🟥') : '⬜';
    archiveItem.innerHTML = `
      ${status} <strong>Game #${index + 1}</strong> - ${book.date}<br>
      <span style="color: #5A4A3A; font-size: 0.85em;">${book.theme} book</span>
    `;
    
    archiveItem.onclick = () => {
      gameData.selectedDate = gameDate;
      document.getElementById('gameSection').classList.remove('hidden');
      document.getElementById('archiveSection').classList.add('hidden');
      loadGame();
    };
    
    archiveList.appendChild(archiveItem);
  });
}

function showToday() {
  gameData.selectedDate = null;
  
  // Clear feedback when switching games
  const feedback = document.getElementById('guessFeedback');
  if (feedback) {
    feedback.classList.add('feedback-hidden');
    feedback.textContent = '';
  }
  
  document.getElementById('gameSection').classList.remove('hidden');
  document.getElementById('archiveSection').classList.add('hidden');
  loadGame();
}

function loadGame() {
  const gameDate = gameData.selectedDate || getTodayNY();
  const savedGame = gameData.gameHistory[gameDate];
  
  // Clear any existing feedback when loading a game
  const feedback = document.getElementById('guessFeedback');
  if (feedback) {
    feedback.classList.add('feedback-hidden');
    feedback.textContent = '';
  }
  
  if (savedGame) {
    gameData.guesses = [...savedGame.guesses];
    gameData.cluesShown = savedGame.cluesUsed;
    gameData.gameOver = savedGame.won || savedGame.guesses.length >= 6;
    
    if (gameData.gameOver) {
      showResults(savedGame.won);
      document.getElementById('inputSection').classList.add('hidden');
    } else {
      document.getElementById('resultSection').classList.add('hidden');
      document.getElementById('inputSection').classList.remove('hidden');
    }
  } else {
    gameData.guesses = [];
    gameData.cluesShown = 1;
    gameData.gameOver = false;
    document.getElementById('resultSection').classList.add('hidden');
    document.getElementById('inputSection').classList.remove('hidden');
  }
  
  updateDisplay();
  showClues();
  displayGuesses();
}

function saveGameState() {
  localStorage.setItem('checkedOutGame', JSON.stringify({
    gameHistory: gameData.gameHistory,
    playerStats: gameData.playerStats
  }));
}

function loadGameState() {
  const saved = localStorage.getItem('checkedOutGame');
  if (saved) {
    const data = JSON.parse(saved);
    gameData.gameHistory = data.gameHistory || {};
    gameData.playerStats = data.playerStats || {
      streak: 0,
      gamesPlayed: 0,
      gamesWon: 0,
      maxStreak: 0,
      lastPlayDate: null
    };
  }
}

function updateCountdown() {
  const now = new Date();
  const tomorrow = new Date(now);
  tomorrow.setDate(tomorrow.getDate() + 1);
  tomorrow.setHours(0, 0, 0, 0);
  
  const timeLeft = tomorrow - now;
  const hours = Math.floor(timeLeft / (1000 * 60 * 60));
  const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
  
  document.getElementById('countdownTime').textContent = 
    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Event listeners
document.getElementById('submitBtn').onclick = submitGuess;
document.getElementById('skipBtn').onclick = skipClue;
document.getElementById('shareBtn').onclick = shareResults;
document.getElementById('todayBtn').onclick = showToday;
document.getElementById('archiveBtn').onclick = showArchive;

document.getElementById('guessInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') submitGuess();
});

// Check for native share support
if (navigator.share) {
  document.getElementById('nativeShareBtn').style.display = 'inline-block';
  document.getElementById('nativeShareBtn').onclick = () => {
    const shareText = generateShareText();
    navigator.share({
      title: 'Checked Out - Southold Free Library',
      text: shareText
    }).catch(err => console.log('Error sharing:', err));
  };
}

// Initialize game
loadGameState();
loadGame();
updateCountdown();
setInterval(updateCountdown, 1000);
</script>
</body>
</html>
