<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelf Life | Southold Free Library</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.05), rgba(52, 152, 219, 0.05));
            border: 1px solid rgba(52, 152, 219, 0.1);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-family: 'Merriweather', serif;
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.02em;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            display: inline-block;
            position: relative;
            flex-shrink: 0;
            margin-right: 5px;
        }
        
        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8bc34a 0%, #8bc34a 45%, #3498db 55%, #3498db 100%);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 34px;
            height: 28px;
            background: white;
            border-radius: 2px;
            clip-path: polygon(
                0% 100%, 
                0% 15%, 
                3% 12%, 
                8% 15%, 
                15% 10%, 
                22% 15%, 
                28% 8%, 
                35% 12%, 
                42% 5%, 
                50% 0%, 
                58% 5%, 
                65% 12%, 
                72% 8%, 
                78% 15%, 
                85% 10%, 
                92% 15%, 
                97% 12%, 
                100% 15%, 
                100% 100%
            );
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .date-info {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.1), rgba(52, 152, 219, 0.1));
            border: 1px solid rgba(52, 152, 219, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .game-number {
            font-weight: 600;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.1rem;
        }
        
        .theme-hint {
            background: white;
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: inline-block;
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 500;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-container {
            background: white;
            border: 1px solid rgba(52, 152, 219, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: inline-block;
        }
        
        .streak-display {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .clue {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.08), rgba(52, 152, 219, 0.08));
            border: 1px solid rgba(52, 152, 219, 0.2);
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
            border-radius: 5px;
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .guess {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            animation: fadeIn 0.3s ease-in;
            font-weight: 500;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .correct {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.15), rgba(139, 195, 74, 0.1));
            border: 2px solid #8bc34a;
            color: #2e7d32;
        }
        
        .incorrect {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }
        
        .skipped {
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            color: #6b7280;
            font-style: italic;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #8bc34a, #3498db);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        button:hover {
            background: linear-gradient(135deg, #7cb342, #2980b9);
            transform: translateY(-1px);
        }
        
        .skip-btn {
            background: #dc2626;
            min-width: 50px;
            font-size: 18px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .skip-btn:hover {
            background: #b91c1c;
        }
        
        .submit-btn {
            min-width: 50px;
            font-size: 18px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .result {
            text-align: center;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .win {
            background: #dcfce7;
            color: #166534;
            border: 2px solid #16a34a;
        }
        
        .lose {
            background: #fef2f2;
            color: #991b1b;
            border: 2px solid #dc2626;
        }
        
        .share-button {
            background: #10b981;
            margin: 10px;
        }
        
        .share-button:hover {
            background: #059669;
        }
        
        .library-link {
            background: white;
            border: 2px solid #2563eb;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .library-link a {
            background: linear-gradient(135deg, #8bc34a, #3498db);
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .library-link a:hover {
            background: linear-gradient(135deg, #7cb342, #2980b9);
            transform: translateY(-1px);
        }
        
        .achievement {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
            color: #92400e;
            font-weight: 600;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .nav-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .nav-buttons button {
            margin: 0 10px 10px 10px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Archive styles */
        .archive-day {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .archive-day:hover {
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .archive-day.played {
            border-color: #16a34a;
            background: #f0fdf4;
        }
        
        .archive-day.unplayed {
            border-color: #e5e7eb;
            background: white;
        }
        
        .archive-day.locked {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .archive-day.locked:hover {
            transform: none;
            box-shadow: none;
            border-color: #d1d5db;
        }
        
        .archive-info h4 {
            margin: 0 0 5px 0;
            color: #1f2937;
        }
        
        .archive-book {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0;
        }
        
        .archive-status {
            font-size: 1.5rem;
        }
        
        .archive-book.locked {
            color: #9ca3af;
            font-style: italic;
        }
    
        /* Responsive design */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .input-group {
                display: flex;
                gap: 8px;
                align-items: stretch;
                margin-top: 15px;
            }
            
            .input-group input {
                flex: 1;
                min-width: 0;
            }
            
            .submit-btn, .skip-btn {
                flex-shrink: 0;
                min-width: 44px;
                width: 44px;
                height: 44px;
                padding: 0;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .nav-buttons button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Shelf Life</h1>
        <p class="subtitle">Daily Book Guessing Game</p>
        <div class="date-info">
            <div class="game-number" id="game-number">Loading...</div>
            <div id="current-date"></div>
        </div>
    </div>

    <div style="text-align: center;">
        <div class="stats-container">
            <div class="streak-display">
                üî• <span id="streak-count">0</span> day streak
            </div>
        </div>
        <div class="theme-hint" id="theme-hint" style="display: none;"></div>
    </div>

    <div class="nav-buttons">
        <button onclick="showTodaysGame()">üìÖ Today's Game</button>
        <button onclick="showArchiveList()">üóÇÔ∏è Archive</button>
    </div>

    <div id="game-section">
        <div class="container">
            <h3>üìã Clues (<span id="clue-count">1</span>/6)</h3>
            <div id="clues"></div>
        </div>

        <div class="container" id="input-section">
            <h3>Your Guess</h3>
            <div class="input-group">
                <input type="text" id="guess-input" placeholder="Enter book title...">
                <button class="submit-btn" onclick="makeGuess()">‚Üí</button>
                <button class="skip-btn" onclick="skipClue()">‚úï</button>
            </div>
        </div>

        <div class="container hidden" id="guesses-section">
            <h3>Your Guesses (<span id="guess-count">0</span>/6)</h3>
            <div id="guesses"></div>
        </div>

        <div class="container hidden" id="result-section">
            <div id="result-text"></div>
            <div style="text-align: center;">
                <button class="share-button" onclick="shareResults()">üìã Copy Results</button>
            </div>
            <div class="library-link">
                <p><strong>üìñ Find this book at Southold Free Library</strong></p>
                <a href="#" id="catalog-link" target="_blank">Search Our Catalog</a>
            </div>
            <div id="achievement-display"></div>
        </div>
    </div>

    <div class="container hidden" id="archive-section">
        <h3>üóÇÔ∏è Game Archive</h3>
        <p style="color: #6b7280; margin-bottom: 20px;">Click any day to play that puzzle</p>
        <div id="archive-list"></div>
    </div>

    <div style="text-align: center; margin-top: 40px; padding: 25px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
        <p style="margin: 0 0 10px 0; font-weight: 500;">Powered by <a href="https://southoldlibrary.org" target="_blank" style="color: #3498db; text-decoration: none; font-weight: 600;">Southold Free Library</a></p>
        <p style="margin: 0; font-size: 12px;">¬© 2025 Southold Free Library. All rights reserved.</p>
    </div>

    <script>
        // Game state
        let currentBook;
        let guesses = [];
        let cluesShown = 1;
        let gameOver = false;
        let selectedDate = null;
        let gameHistory = {};
        let playerStats = { streak: 0, gamesPlayed: 0, gamesWon: 0, achievements: [] };
        let books = [];

        // JSON Data configuration
        const JSON_DATA_URL = 'https://shelf-life-beta.vercel.app/books.json';

        // Game starts on August 22, 2025 (for archive display)
        const GAME_START_DATE = new Date('2025-08-22');

        // Minimal fallback books for emergencies
        const defaultBooks = [
            { 
                date: '2025-08-22',
                title: "THE GREAT GATSBY", 
                author: "F. Scott Fitzgerald", 
                theme: "American Literature",
                clue1: "A mysterious millionaire throws lavish parties"
            },
            { 
                date: '2025-08-23',
                title: "THE 48 LAWS OF POWER", 
                author: "Robert Greene", 
                theme: "Self-Help",
                clue1: "A numbered guide to mastering influence"
            }
        ];

        // Simple JSON loading function
        async function loadBooksFromJSON() {
            console.log('--- LOADING BOOKS FROM JSON ---');
            console.log('JSON URL:', JSON_DATA_URL);
            
            try {
                const response = await fetch(JSON_DATA_URL);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    console.error('Failed to fetch JSON:', response.status);
                    return defaultBooks;
                }
                
                const booksFromJSON = await response.json();
                console.log('Loaded', booksFromJSON.length, 'books from JSON');
                console.log('Books:', booksFromJSON.map(b => b.date + ': ' + b.title));
                
                return booksFromJSON.length > 0 ? booksFromJSON : defaultBooks;
                
            } catch (error) {
                console.error('Error loading JSON:', error);
                console.log('Falling back to default books');
                return defaultBooks;
            }
        }

        // Initialize books on page load
        loadBooksFromJSON().then(loadedBooks => {
            books = loadedBooks;
            console.log('Final books array:', books);
            console.log('Number of books loaded:', books.length);
            console.log('First book:', books[0]);
            initGame();
        });

        // Get current date in EST
        function getCurrentDateEST() {
            const now = new Date();
            const estOffset = -5; // EST is UTC-5
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const est = new Date(utc + (estOffset * 3600000));
            return est;
        }

        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        // Get the current playable book based on EST date and available data
        function getTodaysBook(date = null) {
            let targetDate;
            if (date) {
                targetDate = date;
            } else if (selectedDate) {
                targetDate = selectedDate;
            } else {
                targetDate = getCurrentDateEST();
            }
            
            const todayKey = targetDate.toISOString().split('T')[0];
            console.log('Looking for book for date:', todayKey);
        
            // First, look for exact date match in the sheet
            const bookForToday = books.find(book => book.date === todayKey);
            if (bookForToday) {
                console.log('Found exact date match for ' + todayKey + ':', bookForToday.title);
                return bookForToday;
            }
            
            // If no exact match and this is for "today's game" (not archive), find the most recent available book
            if (!selectedDate) {
                const today = getCurrentDateEST();
                today.setHours(0, 0, 0, 0);
                
                // Find the most recent book that's available (not in the future)
                const availableBooks = books
                    .filter(book => {
                        const bookDate = new Date(book.date);
                        bookDate.setHours(0, 0, 0, 0);
                        return bookDate <= today;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first
                
                if (availableBooks.length > 0) {
                    console.log('Using most recent available book for today:', availableBooks[0].title, 'from', availableBooks[0].date);
                    return availableBooks[0];
                }
            }
        
            // Fallback: return first available book
            console.log('Fallback: using first book');
            return books[0] || null;
        }

        // FIXED: Game numbering starts from August 22, 2025
        function getDayNumber(date = null) {
            const targetDate = date || selectedDate || getCurrentDateEST();
            const daysSinceStart = Math.floor((targetDate - GAME_START_DATE) / (24 * 60 * 60 * 1000));
            return Math.max(1, daysSinceStart + 1);
        }

        function showCurrentDate() {
            const targetDate = selectedDate || getCurrentDateEST();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = targetDate.toLocaleDateString('en-US', options);
            document.getElementById('game-number').textContent = 'Game #' + getDayNumber(targetDate).toString().padStart(3, '0');
            
            // Show theme in small box next to streak if available
            const themeHintElement = document.getElementById('theme-hint');
            if (currentBook && currentBook.theme) {
                themeHintElement.textContent = currentBook.theme;
                themeHintElement.style.display = 'inline-block';
            } else {
                themeHintElement.style.display = 'none';
            }
        }

        function generateClues(book) {
            // Use custom clues from Google Sheets if available
            if (book.clue1) {
                // Add emojis to clues that don't already have them
                const addEmojiIfNeeded = (clue, defaultEmoji) => {
                    if (!clue || !clue.trim()) return clue;
                    // Check if clue already starts with an emoji
                    const hasEmoji = /^[\u{1F000}-\u{1F9FF}]|^[\u{2600}-\u{26FF}]|^[\u{2700}-\u{27BF}]/u.test(clue.trim());
                    return hasEmoji ? clue : defaultEmoji + ' ' + clue;
                };
                
                return [
                    addEmojiIfNeeded(book.clue1, '‚≠ê'),
                    addEmojiIfNeeded(book.clue2, 'üë§'),
                    addEmojiIfNeeded(book.clue3, 'üìÖ'),
                    addEmojiIfNeeded(book.clue4, 'üé≠'),
                    addEmojiIfNeeded(book.clue5, 'üìñ'),
                    addEmojiIfNeeded(book.clue6, 'üë•')
                ].filter(clue => clue && clue.trim());
            }

            // Default clue templates for fallback books
            const specificClues = {
                "THE GREAT GATSBY": [
                    "‚≠ê A mysterious millionaire throws lavish parties hoping to win back his lost love",
                    "üë§ Author: American author, Fitzgerald",
                    "üìÖ Published: 1925",
                    "üé≠ Themes: The American Dream, wealth vs morality, impossible past",
                    "üìñ Setting: Long Island and New York City, summer of 1922",
                    "üë• Character: Jay Gatsby"
                ],
                "THE 48 LAWS OF POWER": [
                    "‚≠ê A numbered guide to mastering influence",
                    "üë§ Uses stories of Napoleon, Cleopatra, Sun Tzu",
                    "üìÖ The most banned book in U.S. prisons",
                    "üé≠ Published in 1998, still a bestseller",
                    "üìñ Known as the Machiavellian Bible",
                    "üë• Author: Robert Greene"
                ]
            };
            
            return specificClues[book.title] || [
                "‚≠ê A compelling story that has captivated readers for generations",
                "üë§ Author: " + book.author.split(' ').slice(-1)[0],
                "üìÖ Era: Classic literature",
                "üé≠ Themes: Human nature and society",
                "üìñ Setting: Various meaningful locations",
                "üë• Features: Memorable characters"
            ];
        }

        // Utility functions
        function normalizeForComparison(title) {
            return title
                .toUpperCase()
                .trim()
                .replace(/[^\w\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/\b(THE|A|AN|TO|OF|AND|IN|ON|AT|BY|FOR|WITH|FROM)\b/g, '')
                .replace(/\bNINETEEN EIGHTY FOUR\b/g, '1984')
                .replace(/\b1984\b/g, 'NINETEEN EIGHTY FOUR')
                .replace(/\bTWENTY THOUSAND LEAGUES UNDER THE SEA\b/g, '20000 LEAGUES UNDER SEA')
                .replace(/\b20000 LEAGUES UNDER SEA\b/g, 'TWENTY THOUSAND LEAGUES UNDER SEA')
                .replace(/\bFAHRENHEIT FOUR HUNDRED FIFTY ONE\b/g, '451')
                .replace(/\b451\b/g, 'FOUR HUNDRED FIFTY ONE')
                .replace(/\bCATCH TWENTY TWO\b/g, '22')
                .replace(/\b22\b/g, 'TWENTY TWO')
                .replace(/\bTWO THOUSAND ONE\b/g, '2001')
                .replace(/\b2001\b/g, 'TWO THOUSAND ONE')
                .replace(/\bONE HUNDRED\b/g, '100')
                .replace(/\b100\b/g, 'ONE HUNDRED')
                .replace(/\bFIFTY\b/g, '50')
                .replace(/\b50\b/g, 'FIFTY')
                .replace(/\bTWENTY\b/g, '20')
                .replace(/\b20\b/g, 'TWENTY')
                .replace(/\bTHIRTY\b/g, '30')
                .replace(/\b30\b/g, 'THIRTY')
                .replace(/\bONE\b/g, '1')
                .replace(/\b1\b/g, 'ONE')
                .replace(/\bTWO\b/g, '2')
                .replace(/\b2\b/g, 'TWO')
                .replace(/\bTHREE\b/g, '3')
                .replace(/\b3\b/g, 'THREE')
                .replace(/\bFOUR\b/g, '4')
                .replace(/\b4\b/g, 'FOUR')
                .replace(/\bFIVE\b/g, '5')
                .replace(/\b5\b/g, 'FIVE')
                .replace(/\bSIX\b/g, '6')
                .replace(/\b6\b/g, 'SIX')
                .replace(/\bSEVEN\b/g, '7')
                .replace(/\b7\b/g, 'SEVEN')
                .replace(/\bEIGHT\b/g, '8')
                .replace(/\b8\b/g, 'EIGHT')
                .replace(/\bNINE\b/g, '9')
                .replace(/\b9\b/g, 'NINE')
                .replace(/\bTEN\b/g, '10')
                .replace(/\b10\b/g, 'TEN')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function titlesMatch(guess, target) {
            const normalizedGuess = normalizeForComparison(guess);
            const normalizedTarget = normalizeForComparison(target);
            
            return normalizedGuess === normalizedTarget;
        }

        // Game functions
        function loadGameHistory() {
            try {
                const saved = localStorage.getItem('shelflife-history');
                gameHistory = saved ? JSON.parse(saved) : {};
                
                const savedStats = localStorage.getItem('shelflife-stats');
                if (savedStats) {
                    playerStats = { ...playerStats, ...JSON.parse(savedStats) };
                }
                
                updateStatsDisplay();
            } catch (e) {
                gameHistory = {};
            }
        }

        function saveGameHistory() {
            try {
                localStorage.setItem('shelflife-history', JSON.stringify(gameHistory));
                localStorage.setItem('shelflife-stats', JSON.stringify(playerStats));
            } catch (e) {
                // localStorage not available
            }
        }

        function updateStatsDisplay() {
            document.getElementById('streak-count').textContent = playerStats.streak;
        }

        function updateCatalogLink(book) {
            const catalogLink = document.getElementById('catalog-link');
            if (book && book.isbn) {
                catalogLink.href = 'https://southold-suffc.na.iiivega.com/search?query=' + encodeURIComponent(book.isbn);
            } else if (book) {
                const searchQuery = (book.title + ' ' + book.author).replace(/[^\w\s]/g, ' ').trim();
                catalogLink.href = 'https://southold-suffc.na.iiivega.com/search?query=' + encodeURIComponent(searchQuery);
            } else {
                catalogLink.href = 'https://southold-suffc.na.iiivega.com';
            }
        }

        function showClues() {
            const clues = generateClues(currentBook);
            const cluesContainer = document.getElementById('clues');
            cluesContainer.innerHTML = '';
            
            for (let i = 0; i < cluesShown; i++) {
                const clueDiv = document.createElement('div');
                clueDiv.className = 'clue';
                clueDiv.textContent = clues[i] || 'Clue ' + (i + 1) + ' not available';
                cluesContainer.appendChild(clueDiv);
            }
            
            document.getElementById('clue-count').textContent = cluesShown;
        }

        function updateDailyStats(won) {
            playerStats.gamesPlayed++;
            
            if (won) {
                playerStats.gamesWon++;
                
                const today = getCurrentDateEST();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const todayKey = getDateKey(today);
                const yesterdayKey = getDateKey(yesterday);
                
                const yesterdayGame = gameHistory[yesterdayKey];
                const todayGame = gameHistory[todayKey];
                
                if (!todayGame || !todayGame.gameOver) {
                    if (yesterdayGame && yesterdayGame.won) {
                        playerStats.streak++;
                    } else if (yesterdayGame && yesterdayGame.gameOver && !yesterdayGame.won) {
                        playerStats.streak = 1;
                    } else if (!yesterdayGame) {
                        let hasGap = false;
                        
                        for (let i = 1; i <= 7; i++) {
                            const checkDate = new Date(today);
                            checkDate.setDate(checkDate.getDate() - i - 1);
                            const checkKey = getDateKey(checkDate);
                            
                            if (gameHistory[checkKey] && gameHistory[checkKey].gameOver) {
                                hasGap = true;
                                break;
                            }
                        }
                        
                        if (hasGap) {
                            playerStats.streak = 1;
                        } else {
                            playerStats.streak++;
                        }
                    } else {
                        playerStats.streak = 1;
                    }
                }
            } else {
                playerStats.streak = 0;
            }
        }

        function skipClue() {
            if (gameOver || cluesShown >= 6) return;
            
            guesses.push({ text: "SKIPPED", correct: false, isSkip: true });
            cluesShown = Math.min(6, cluesShown + 1);
            showClues();
            
            if (guesses.length >= 6) {
                gameOver = true;
                
                if (!selectedDate || getDateKey(selectedDate) === getDateKey(getCurrentDateEST())) {
                    updateDailyStats(false);
                }
                
                endGame(false);
            }
            
            displayGuesses();
            saveGameState();
        }

        function makeGuess() {
            if (gameOver) return;
            
            const input = document.getElementById('guess-input');
            const guess = input.value.trim();
            
            if (!guess) return;
            
            const isCorrect = titlesMatch(guess, currentBook.title);
            guesses.push({ text: guess.toUpperCase(), correct: isCorrect });
            
            input.value = '';
            
            if (isCorrect) {
                gameOver = true;
                
                if (!selectedDate || getDateKey(selectedDate) === getDateKey(getCurrentDateEST())) {
                    updateDailyStats(true);
                }
                
                checkAchievements(true);
                endGame(true);
            } else {
                cluesShown = Math.min(6, cluesShown + 1);
                showClues();
                
                if (guesses.length >= 6) {
                    gameOver = true;
                    
                    if (!selectedDate || getDateKey(selectedDate) === getDateKey(getCurrentDateEST())) {
                        updateDailyStats(false);
                    }
                    
                    endGame(false);
                }
            }
            
            displayGuesses();
            saveGameState();
        }

        function displayGuesses() {
            if (guesses.length === 0) return;
            
            document.getElementById('guesses-section').classList.remove('hidden');
            const guessesContainer = document.getElementById('guesses');
            guessesContainer.innerHTML = '';
            
            guesses.forEach(guess => {
                const guessDiv = document.createElement('div');
                if (guess.isSkip) {
                    guessDiv.className = 'guess skipped';
                } else {
                    guessDiv.className = 'guess ' + (guess.correct ? 'correct' : 'incorrect');
                }
                guessDiv.textContent = guess.text;
                guessesContainer.appendChild(guessDiv);
            });
            
            document.getElementById('guess-count').textContent = guesses.length;
        }

        function endGame(won = false) {
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');
            
            updateCatalogLink(currentBook);
            
            const resultDiv = document.getElementById('result-text');
            if (won) {
                const actualGuesses = guesses.filter(g => !g.isSkip).length;
                resultDiv.innerHTML = '<div class="result win"><h3>Congratulations!</h3><p>You guessed "<strong>' + currentBook.title + '</strong>" by ' + currentBook.author + ' in ' + actualGuesses + ' guess' + (actualGuesses === 1 ? '' : 'es') + '!</p></div>';
            } else {
                resultDiv.innerHTML = '<div class="result lose"><h3>Better luck next time!</h3><p>The book was "<strong>' + currentBook.title + '</strong>" by ' + currentBook.author + '</p></div>';
            }
            
            updateStatsDisplay();
        }

        function checkAchievements(won) {
            const achievements = [
                { id: "first_win", name: "First Victory", description: "Win your first game", emoji: "üéâ" },
                { id: "streak_3", name: "Hot Streak", description: "Win 3 days in a row", emoji: "üî•" },
                { id: "perfect_game", name: "Perfect Game", description: "Win with only 1 guess", emoji: "üíé" },
                { id: "bookworm", name: "Bookworm", description: "Play 25 games", emoji: "üìö" }
            ];

            const newAchievements = [];
            
            if (won && !playerStats.achievements.includes('first_win') && playerStats.gamesWon === 1) {
                newAchievements.push('first_win');
            }
            
            if (won && guesses.filter(g => !g.isSkip).length === 1 && !playerStats.achievements.includes('perfect_game')) {
                newAchievements.push('perfect_game');
            }
            
            if (playerStats.streak >= 3 && !playerStats.achievements.includes('streak_3')) {
                newAchievements.push('streak_3');
            }
            
            if (playerStats.gamesPlayed >= 25 && !playerStats.achievements.includes('bookworm')) {
                newAchievements.push('bookworm');
            }
            
            newAchievements.forEach(achievementId => {
                if (!playerStats.achievements.includes(achievementId)) {
                    playerStats.achievements.push(achievementId);
                    showAchievement(achievementId, achievements);
                }
            });
        }

        function showAchievement(achievementId, achievementsList) {
            const achievement = achievementsList.find(a => a.id === achievementId);
            if (!achievement) return;
            
            const achievementEl = document.createElement('div');
            achievementEl.className = 'achievement';
            achievementEl.innerHTML = '<strong>' + achievement.emoji + ' ' + achievement.name + '</strong><br><span style="font-size: 14px;">' + achievement.description + '</span>';
            
            document.getElementById('achievement-display').appendChild(achievementEl);
        }

        function shareResults() {
            const dateKey = getDateKey(selectedDate || getCurrentDateEST());
            const gameData = gameHistory[dateKey];
            
            if (!gameData) return;
            
            const dayNumber = getDayNumber();
            const guessEmojis = gameData.guesses.map(guess => {
                if (guess.isSkip) return '‚≠ï';
                return guess.correct ? 'üü©' : 'üü•';
            });
            
            while (guessEmojis.length < 6 && gameData.won) {
                guessEmojis.push('‚¨ú');
            }
            
            const result = gameData.won ? (guessEmojis.length + '/6') : 'X/6';
            const shareText = 'Shelf Life #' + dayNumber + ' ' + result + '\n\n' + guessEmojis.join('') + '\n\nCurrent streak: ' + playerStats.streak + '\n\nDaily book guessing game: ' + window.location.href;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.style.background = '#10b981';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#10b981';
                    }, 2000);
                });
            } else {
                prompt('Copy this text to share:', shareText);
            }
        }

        function saveGameState() {
            const dateKey = getDateKey(selectedDate || getCurrentDateEST());
            gameHistory[dateKey] = {
                guesses: guesses,
                cluesShown: cluesShown,
                gameOver: gameOver,
                won: gameOver && guesses.some(g => g.correct),
                book: currentBook
            };
            saveGameHistory();
        }

        function loadGameState() {
            const dateKey = getDateKey(selectedDate || getCurrentDateEST());
            const savedGame = gameHistory[dateKey];
            
            if (savedGame) {
                guesses = savedGame.guesses || [];
                cluesShown = savedGame.cluesShown || 1;
                gameOver = savedGame.gameOver || false;
                
                displayGuesses();
                if (gameOver) {
                    endGame(savedGame.won);
                }
            } else {
                guesses = [];
                cluesShown = 1;
                gameOver = false;
            }
        }

        function showArchiveList() {
    const archiveList = document.getElementById('archive-list');
    archiveList.innerHTML = '';

    // find earliest puzzle date
    const allDates = Object.keys(books).map(d => new Date(d));
    const minDate = new Date(Math.min(...allDates));
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // build list from earliest puzzle up to today (and maybe future)
    const dates = [];
    for (let d = new Date(today); d >= minDate; d.setDate(d.getDate() - 1)) {
        dates.push(new Date(d));
    }

    dates.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const isFuture = date > today;
        const dayData = gameData[dateStr] || {};
        const book = books[dateStr];

        let statusIcon = '';
        let bookInfo = '';

        if (isFuture) {
            statusIcon = 'üîí';
            bookInfo = '<p class="archive-book locked">Available on ' +
                        date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + '</p>';
        } else if (dayData.gameOver && dayData.solved && book) {
            statusIcon = '‚úÖ';
            bookInfo = '<p class="archive-book">' + book.title + ' by ' + book.author + '</p>';
        } else if (dayData.gameOver && !dayData.solved) {
            statusIcon = '‚ùå';
            bookInfo = '<p class="archive-book locked">Unsolved puzzle</p>';
        } else {
            statusIcon = '‚ö™';
            bookInfo = '<p class="archive-book locked">Unplayed puzzle</p>';
        }

        const archiveItem = document.createElement('div');
        archiveItem.className = 'archive-item';
        archiveItem.innerHTML = `
            <div class="archive-header">
                <span class="archive-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                <span class="archive-status">${statusIcon}</span>
            </div>
            ${bookInfo}
        `;

        if (dayData.gameOver && book) {
            archiveItem.addEventListener('click', () => {
                loadGame(dateStr, { reviewMode: true });
                document.getElementById('archiveModal').style.display = 'none';
            });
        }

        archiveList.appendChild(archiveItem);
    });

    document.getElementById('archiveModal').style.display = 'block';
}

        archiveList.appendChild(archiveItem);
    });

    document.getElementById('archiveModal').style.display = 'block';
}
        
                archiveList.appendChild(dayDiv);
            });
        }

        function showTodaysGame() {
            selectedDate = null;
            document.getElementById('archive-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            initGame();
        }

        function playArchiveDay(date) {
            selectedDate = date;
            document.getElementById('archive-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');
            initGame();
        }

        function resetGameUI() {
            document.getElementById('guesses-section').classList.add('hidden');
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('guess-input').value = '';
            document.getElementById('achievement-display').innerHTML = '';
            
            const inputSection = document.getElementById('input-section');
            const paragraphs = inputSection.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (p.textContent.includes('Skipping') || p.textContent.includes('clue')) {
                    p.remove();
                }
            });
        }

        function initGame() {
            if (books.length === 0) {
                console.log('No books loaded yet');
                return;
            }
            
            console.log('=== INIT GAME DEBUG (EST) ===');
            const estDate = getCurrentDateEST();
            console.log('Current date (EST):', estDate.toISOString().split('T')[0]);
            console.log('Selected date:', selectedDate ? selectedDate.toISOString().split('T')[0] : 'none');
            console.log('Available books:');
            books.forEach((book, index) => {
                console.log(index + ': ' + book.date + ' - ' + book.title);
            });
            
            loadGameHistory();
            currentBook = getTodaysBook();
            console.log('Selected current book:', currentBook ? currentBook.title : 'none', 'for date', currentBook ? currentBook.date : 'none');
            showCurrentDate();
            resetGameUI();
            loadGameState();
            showClues();
            updateStatsDisplay();
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadGameHistory();
            
            document.getElementById('guess-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    makeGuess();
                }
            });
        });
    </script>
</body>
</html>
